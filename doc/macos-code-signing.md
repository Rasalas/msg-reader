# macOS Code Signing & Notarization for Tauri

This guide describes how to sign and notarize the msgReader desktop app with an Apple Developer certificate, so macOS users can open it without Gatekeeper warnings.

## Prerequisites

- Apple Developer Account ($99/year)
- macOS with Keychain Access
- Access to GitHub repository settings

## Overview of Required Passwords

| Password | Description |
|----------|-------------|
| **Certificate password** | You choose this when exporting the .p12 file |
| **App-specific password** | Generated by Apple for the notarization API |

---

## Step 1: Create Developer ID Certificate

1. Go to [developer.apple.com/account](https://developer.apple.com/account)
2. Navigate to **Certificates, Identifiers & Profiles** → **Certificates**
3. Click **+** (create new certificate)
4. Select **Developer ID Application** under "Software"
5. You need a **Certificate Signing Request (CSR)**:

### Create CSR (on your Mac)

1. Open **Keychain Access**
2. Menu: **Keychain Access** → **Certificate Assistant** → **Request a Certificate From a Certificate Authority...**
3. Fill in:
   - **User Email Address**: Your Apple ID
   - **Common Name**: Your name
   - **CA Email Address**: leave empty
   - **Request is**: **Saved to disk**
4. Save as `CertificateSigningRequest.certSigningRequest`

### Complete the Certificate

6. Upload the CSR file to Apple
7. Click **Download** to get the certificate (`.cer` file)
8. **Double-click** the `.cer` file → it will be installed in your Keychain automatically

---

## Step 2: Export Certificate as .p12

1. Open **Keychain Access**
2. Select category **My Certificates** on the left
3. Find the certificate **Developer ID Application: Your Name (TEAM_ID)**
   - Important: It must have a small triangle to expand (shows the private key)
4. **Right-click** → **Export...**
5. Format: **Personal Information Exchange (.p12)**
6. Save as `certificate.p12`
7. **Set a password** - you'll need this later as `APPLE_CERTIFICATE_PASSWORD`

> **Security note**: Store the .p12 file securely and never share it publicly. It contains your private key.

---

## Step 3: Create App-Specific Password

Apple doesn't allow storing your real password in CI/CD systems. Instead, you create an app-specific password:

1. Go to [appleid.apple.com](https://appleid.apple.com)
2. Sign in
3. Navigate to **Sign-In and Security** → **App-Specific Passwords**
4. Click **+** or **Generate a password**
5. Enter a name, e.g., `GitHub Actions Notarization`
6. **Copy the generated password** (format: `xxxx-xxxx-xxxx-xxxx`)

> This password is only shown once. Store it securely.

---

## Step 4: Find Your Team ID

1. Go to [developer.apple.com/account](https://developer.apple.com/account)
2. Click **Membership Details** on the left
3. Your **Team ID** is listed there (10 alphanumeric characters, e.g., `ABC123XYZ9`)

---

## Step 5: Get Your Signing Identity

The signing identity is the exact name of your certificate. Run in Terminal:

```bash
security find-identity -v -p codesigning
```

Look for the line with **Developer ID Application**:

```
2) ABCDEF123456... "Developer ID Application: John Doe (ABC123XYZ9)"
```

The complete text in quotes is your **Signing Identity**:
`Developer ID Application: John Doe (ABC123XYZ9)`

---

## Step 6: Base64-Encode the .p12 File

GitHub Secrets can't store binary files, so the .p12 file must be Base64-encoded:

```bash
base64 -i certificate.p12 -o certificate-base64.txt
```

The contents of `certificate-base64.txt` will be used as the `APPLE_CERTIFICATE` secret.

> After uploading, you can safely delete `certificate.p12` and `certificate-base64.txt`.

---

## Step 7: Configure GitHub Secrets

1. Go to your GitHub repository
2. **Settings** → **Secrets and variables** → **Actions**
3. Click **New repository secret** for each secret:

| Secret Name | Value | Example |
|-------------|-------|---------|
| `APPLE_CERTIFICATE` | Contents of certificate-base64.txt | (long Base64 string) |
| `APPLE_CERTIFICATE_PASSWORD` | Password from .p12 export | `mySecurePassword123` |
| `APPLE_SIGNING_IDENTITY` | Exact certificate name | `Developer ID Application: John Doe (ABC123XYZ9)` |
| `APPLE_ID` | Your Apple ID email | `john@example.com` |
| `APPLE_PASSWORD` | App-specific password | `xxxx-xxxx-xxxx-xxxx` |
| `APPLE_TEAM_ID` | Your Team ID | `ABC123XYZ9` |

---

## Step 8: Update GitHub Actions Workflow

The `tauri-build.yml` workflow needs to include the Apple signing environment variables.

Add these environment variables to the **Build Tauri App** step:

```yaml
- name: Build Tauri App
  uses: tauri-apps/tauri-action@v0
  env:
    GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    # Tauri Update Signing
    TAURI_SIGNING_PRIVATE_KEY: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY }}
    TAURI_SIGNING_PRIVATE_KEY_PASSWORD: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY_PASSWORD }}
    # Apple Code Signing (macOS only)
    APPLE_CERTIFICATE: ${{ secrets.APPLE_CERTIFICATE }}
    APPLE_CERTIFICATE_PASSWORD: ${{ secrets.APPLE_CERTIFICATE_PASSWORD }}
    APPLE_SIGNING_IDENTITY: ${{ secrets.APPLE_SIGNING_IDENTITY }}
    APPLE_ID: ${{ secrets.APPLE_ID }}
    APPLE_PASSWORD: ${{ secrets.APPLE_PASSWORD }}
    APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}
```

The `tauri-action` automatically detects these variables and performs signing + notarization.

---

## Verification

After a successful build, you can verify the signature locally:

```bash
# Check signature
codesign -dv --verbose=4 /Applications/msgReader.app

# Check notarization
spctl -a -vvv -t install /Applications/msgReader.app
```

On successful notarization, the output should contain:
```
source=Notarized Developer ID
```

---

## Troubleshooting

### "The specified item could not be found in the keychain"
- Make sure the .p12 file was correctly Base64-encoded
- Verify the certificate password is correct

### "No signing identity found"
- The `APPLE_SIGNING_IDENTITY` must exactly match the certificate name
- Run `security find-identity -v -p codesigning` to find the correct name

### "Unable to upload your app for notarization"
- Check if the app-specific password is correct
- Ensure Apple ID and Team ID match

### Notarization takes a long time
- Notarization can take 5-15 minutes
- During high load on Apple's servers, it may take longer

---

## What Happens When Developer Membership Expires?

- **Already signed apps continue to work** - signature and notarization remain valid
- New versions cannot be signed
- The certificate will be revoked after expiration, but existing signatures remain intact
